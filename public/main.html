<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‚ºä»€éº¼è¦æ¼”å¥æ˜¥æ—¥å½±</title>

<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: #f4f7f6;
  margin: 0;
}
header {
  background: #2c3e50;
  color: #fff;
  padding: 1rem 5%;
  display: flex;
  justify-content: space-between;
}
nav a {
  color: #fff;
  margin-left: 20px;
  cursor: pointer;
}
.container {
  max-width: 900px;
  margin: 30px auto;
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 30px;
}
.post {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  position: relative;
}
.post-meta {
  font-size: .8rem;
  color: #999;
}
textarea, input {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
}
.btn {
  padding: 8px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
.btn-main { background: #3a96b3; color: white; }
.btn-danger { background: #ff7675; color: white; }

.delete-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  padding: 6px 10px;
  font-size: 0.85rem;
}

.post img {
  max-width: 100%;
  border-radius: 8px;
  margin-top: 10px;
}

.sidebar {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
}
</style>
</head>

<body>

<header>
  <h1>ğŸ¸ ç‚ºä»€éº¼è¦æ¼”å¥æ˜¥æ—¥å½±</h1>
  <nav>
    <a href="profile.html">å€‹äººè³‡æ–™</a>
    <a id="logout" style="color:#ff7675;">ç™»å‡º</a>
  </nav>
</header>

<div class="container">

<main id="post-area">
  <!-- ç™¼æ–‡å€ -->
  <article class="post">
    <h3>âœï¸ ç™¼è¡¨æ–°è²¼æ–‡</h3>
    <input id="post-title" placeholder="æ¨™é¡Œ">
    <textarea id="post-content" rows="4" placeholder="å…§å®¹"></textarea>

    <!-- âœ… æ–°å¢åœ–ç‰‡ä¸Šå‚³ -->
    <input type="file" id="post-image" accept="image/*">

    <button id="post-submit" class="btn btn-main">é€å‡º</button>
  </article>
</main>

<aside class="sidebar">
  <p>ç™»å…¥å¸³è™Ÿ</p>
  <h4 id="user-email">è¼‰å…¥ä¸­...</h4>
  <a href="profile.html" class="btn btn-main">æŸ¥çœ‹å€‹äººè³‡æ–™</a>
  <a id="admin-btn" class="btn btn-main" style="display:none;">ğŸ›  ç®¡ç†å“¡å¾Œå°</a>
</aside>

</div>

<script>
const token = localStorage.getItem('auth_token');
let isAdmin = false;

if (!token) location.href = "index.html";

document.getElementById('logout').onclick = () => {
  localStorage.removeItem('auth_token');
  location.href = "index.html";
};

(async () => {
  try {
    const res = await fetch('/api/auth/profile', {
      headers: { Authorization: 'Bearer ' + token }
    });
    if (!res.ok) throw 'invalid';

    const data = await res.json();
    document.getElementById('user-email').textContent = data.user.email;

    await checkAdmin();
    loadPosts();
  } catch {
    localStorage.removeItem('auth_token');
    location.href = "index.html";
  }
})();

async function checkAdmin() {
  const res = await fetch('/api/admin/dashboard', {
    headers: { Authorization: 'Bearer ' + token }
  });
  if (res.status === 200) {
    isAdmin = true;
    document.getElementById('admin-btn').style.display = 'block';
    document.getElementById('admin-btn').onclick = () => location.href = "admin.html";
  }
}

async function loadPosts() {
  const res = await fetch('/api/posts');
  const posts = await res.json();
  const area = document.getElementById('post-area');

  const composer = area.querySelector('article.post');
  area.innerHTML = '';
  area.appendChild(composer);

  posts.forEach(p => {
    const post = document.createElement('article');
    post.className = 'post';

    post.innerHTML = `
      <div class="post-meta">ç™¼ä½ˆè€…ï¼š${p.author}</div>

      ${isAdmin ? `
        <button class="btn btn-danger delete-btn" data-id="${p.id}">
          ğŸ—‘ åˆªé™¤è²¼æ–‡
        </button>` : ''}

      <h3>${p.title}</h3>
      <p>${p.content}</p>

      ${p.image ? `<img src="${p.image}">` : ''}

      <div class="comments">
        <h4>ğŸ’¬ ç•™è¨€</h4>
        ${p.comments.map(c => `
          <div><strong>${c.author}ï¼š</strong>${c.content}</div>
        `).join('')}

        <textarea rows="2" placeholder="ç•™è¨€..." data-post="${p.id}"></textarea>
        <button class="btn btn-main comment-btn" data-post="${p.id}">é€å‡ºç•™è¨€</button>
      </div>
    `;
    area.appendChild(post);
  });
}

/* âœ… ç™¼æ–‡ï¼ˆæ”¹ç”¨ FormDataï¼‰ */
document.getElementById('post-submit').onclick = async () => {
  const title = document.getElementById('post-title').value.trim();
  const content = document.getElementById('post-content').value.trim();
  const image = document.getElementById('post-image').files[0];

  if (!title || !content) return alert("è«‹å¡«å®Œæ•´");

  const formData = new FormData();
  formData.append('title', title);
  formData.append('content', content);
  if (image) formData.append('image', image);

  const res = await fetch('/api/posts', {
    method: 'POST',
    headers: {
      Authorization: 'Bearer ' + token
    },
    body: formData
  });

  if (res.ok) location.reload();
  else alert('ç™¼æ–‡å¤±æ•—');
};

async function deletePost(id) {
  if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
  const res = await fetch(`/api/posts/${id}`, {
    method: 'DELETE',
    headers: { Authorization: 'Bearer ' + token }
  });
  if (res.ok) location.reload();
}

document.addEventListener('click', async e => {
  if (e.target.classList.contains('delete-btn')) {
    return deletePost(e.target.dataset.id);
  }

  if (!e.target.classList.contains('comment-btn')) return;

  const postId = e.target.dataset.post;
  const textarea = document.querySelector(`textarea[data-post="${postId}"]`);
  const content = textarea.value.trim();
  if (!content) return alert('è«‹è¼¸å…¥ç•™è¨€');

  const res = await fetch(`/api/posts/${postId}/comments`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer ' + token
    },
    body: JSON.stringify({ content })
  });
  if (res.ok) location.reload();
});
</script>

</body>
</html>
